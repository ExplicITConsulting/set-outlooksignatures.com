---
layout: "none"
sitemap: false
---

{%- comment -%} Create a prioritized language list {%- endcomment -%}
{%- assign default_lang = site.default_lang | default: site.languages.first -%}
{%- assign sorted_langs = site.languages -%}
{%- if default_lang -%}
  {%- assign sorted_langs = sorted_langs | unshift: default_lang | uniq -%}
{%- endif -%}

{%- assign unique_permalinks = "" | split: "" -%}

<?xml version="1.0" encoding="UTF-8"?>
<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9" xmlns:xhtml="http://www.w3.org/1999/xhtml">


{%- for node in site.pages -%}
  {%- comment -%} Filter stuff that should not be in the sitemap {%- endcomment -%}
  {%- unless node.sitemap == false or node.url contains '/robots.txt' or node.url contains '/redirects.json' or node.url contains '/assets/' or node.url contains '/404' -%}

    {%- comment -%} Get the URL to be used for x-default based on the prioritized language list {%- endcomment -%}
    {%- assign xDefaultUrl = "" -%}
    {%- for languageCode in sorted_langs -%}
      {%- if node.permalink_lang[languageCode] -%}
        {%- if xDefaultUrl == "" -%}
          {%- if languageCode == default_lang -%}
            {%- assign xDefaultUrl = node.permalink_lang[languageCode] | absolute_url | replace: "//", "/"  | replace: "http:/", "http://" | replace: "https:/", "https://" -%}
          {%- else -%}
            {%- assign languagePrefix = "/" | append: languageCode | append: node.permalink_lang[languageCode] | absolute_url | replace: "//", "/"  | replace: "http:/", "http://" | replace: "https:/", "https://" -%}
          {%- endif -%}
        {%- endif -%}
      {%- endif -%}
    {%- endfor -%}


    {%- comment -%} Create a url entry for each language specific permalink of the node {%- endcomment -%}
    {%- for languageCode in sorted_langs -%}
      {%- if languageCode == default_lang -%}
        {%- assign languagePrefix = "" -%}
      {%- else -%}
        {%- assign languagePrefix = "/" | append: languageCode -%}
      {%- endif -%}

      {%- if node.permalink_lang[languageCode] %}
        {%- assign current_permalink = languagePrefix | append: node.permalink_lang[languageCode] | absolute_url | replace: "//", "/"  | replace: "http:/", "http://" | replace: "https:/", "https://"  -%}
        {%- unless unique_permalinks contains current_permalink -%}
          {%- assign unique_permalinks = unique_permalinks | push: current_permalink -%}
  <url>
    <loc>{{ languagePrefix | append: node.permalink_lang[languageCode] | absolute_url | replace: "//", "/"  | replace: "http:/", "http://" | replace: "https:/", "https://" }}</loc>
    <lastmod>{{ node.last_modified_at | default: node.date | default: site.time | date_to_xmlschema }}</lastmod>

          {%- if xDefaultUrl != "" %}
    <xhtml:link rel="alternate" hreflang="x-default" href="{{ xDefaultUrl }}" />
          {%- endif -%}

          {%- for languageCode in sorted_langs -%}
            {%- if node.permalink_lang[languageCode] -%}
              {%- if languageCode == default_lang -%}
                {%- assign languagePrefix = "" -%}
              {%- else -%}
                {%- assign languagePrefix = "/" | append: languageCode -%}
              {%- endif %}
    <xhtml:link rel="alternate" hreflang="{{ languageCode }}" href="{{ languagePrefix | append: node.permalink_lang[languageCode] | absolute_url | replace: "//", "/"  | replace: "http:/", "http://" | replace: "https:/", "https://" }}" />
            {%- endif -%}
          {%- endfor %}
  </url>
        {%- endunless -%}
      {%- endif -%}
    {%- endfor -%}
  {%- endunless -%}
{%- endfor %}

{%- comment -%}
POSTS - Final Corrected Liquid Block (Grouping by Resolved Path)
----------------------------------------------------------------
Grouping: The resolved post.url, stripped of its language prefix.
This ensures all language variants resolve to the same canonical path key.
{%- endcomment -%}

{%- assign processed_post_group_keys = "" | split: "" -%}
{%- assign processed_post_urls = "" | split: "" -%}

{%- for root_post in site.posts -%}
  {%- comment -%} Filter stuff that should not be in the sitemap {%- endcomment -%}
  {%- unless root_post.sitemap == false or root_post.url contains '/robots.txt' or root_post.url contains '/redirects.json' or root_post.url contains '/assets/' or root_post.url contains '/404' -%}

    {%- comment -%} Determine the language-agnostic grouping key (canonical path) {%- endcomment -%}
    {%- assign post_lang = root_post.lang | default: default_lang -%}
    {%- assign base_url = root_post.url -%}

    {%- comment -%} Strip the language prefix to get the canonical path key {%- endcomment -%}
    {%- if post_lang != default_lang -%}
      {%- assign prefix = "/" | append: post_lang -%}
      {%- if base_url contains prefix -%}
        {%- assign base_url = base_url | remove_first: prefix -%}
      {%- endif -%}
    {%- endif -%}
    
    {%- comment -%} Fallback to page_id if stripping the language prefix leaves a non-unique value (highly unlikely but safeguards grouping) {%- endcomment -%}
    {%- assign group_key = base_url | default: root_post.page_id -%}

    {%- if group_key and group_key != "" -%}
      {%- comment -%} Check if this group (canonical path) has been fully processed {%- endcomment -%}
      {%- unless processed_post_group_keys contains group_key -%}

        {%- comment -%} New group found. Mark it as processed and initialize maps. {%- endcomment -%}
        {%- assign processed_post_group_keys = processed_post_group_keys | push: group_key -%}
        {%- assign lang_url_map = {} -%}
        {%- assign lang_lastmod_map = {} -%}
        {%- assign xDefaultUrl = "" -%}

        {%- comment -%} Second loop: Find all variants belonging to this group_key {%- endcomment -%}
        {%- for variant_post in site.posts -%}
          {%- assign variant_lang = variant_post.lang | default: default_lang -%}
          {%- assign variant_base_url = variant_post.url -%}

          {%- comment -%} Re-create the canonical path key for the variant {%- endcomment -%}
          {%- if variant_lang != default_lang -%}
            {%- assign prefix = "/" | append: variant_lang -%}
            {%- if variant_base_url contains prefix -%}
              {%- assign variant_base_url = variant_base_url | remove_first: prefix -%}
            {%- endif -%}
          {%- endif -%}
          {%- assign variant_group_key = variant_base_url | default: variant_post.page_id -%}

          {%- if variant_group_key == group_key -%}
            {%- comment -%} Found a sibling: map its URL and lastmod by its language {%- endcomment -%}
            
            {%- comment -%} Normalize the unique URL for this variant {%- endcomment -%}
            {%- assign variant_url_raw = variant_post.url | absolute_url | replace: "//", "/"  | replace: "http:/", "http://" | replace: "https:/", "https://" -%}
            
            {%- assign lang_url_map = lang_url_map | merge: variant_lang : variant_url_raw -%}
            {%- assign lang_lastmod_map = lang_lastmod_map | merge: variant_lang : variant_post.last_modified_at | default: variant_post.date | default: site.time | date_to_xmlschema -%}

            {%- comment -%} Set x-default URL if it is the default language {%- endcomment -%}
            {%- if variant_lang == default_lang -%}
              {%- assign xDefaultUrl = variant_url_raw -%}
            {%- endif -%}
          {%- endif -%}
        {%- endfor -%}

        {%- comment -%} Finalize x-default URL if not set {%- endcomment -%}
        {%- if xDefaultUrl == "" -%}
          {%- for languageCode in sorted_langs -%}
            {%- if lang_url_map[languageCode] -%}
              {%- assign xDefaultUrl = lang_url_map[languageCode] -%}
              {%- break -%}
            {%- endif -%}
          {%- endfor -%}
        {%- endif -%}

        {%- comment -%} Output <url> entry for each language variant found {%- endcomment -%}
        {%- for languageCode in sorted_langs -%}
          {%- assign current_permalink = lang_url_map[languageCode] -%}
          {%- assign current_lastmod = lang_lastmod_map[languageCode] -%}

          {%- if current_permalink -%}
            {%- comment -%} Ensure this specific URL isn't duplicated by pages or other post runs {%- endcomment -%}
            {%- unless processed_post_urls contains current_permalink or unique_permalinks contains current_permalink -%}
              {%- assign processed_post_urls = processed_post_urls | push: current_permalink -%}
  <url>
    <loc>{{ current_permalink }}</loc>
    <lastmod>{{ current_lastmod }}</lastmod>

              {%- if xDefaultUrl != "" %}
    <xhtml:link rel="alternate" hreflang="x-default" href="{{ xDefaultUrl }}" />
              {%- endif -%}

              {%- comment -%} Add all other variants as alternates {%- endcomment -%}
              {%- for alternate_lang in sorted_langs -%}
                {%- if lang_url_map[alternate_lang] -%}
    <xhtml:link rel="alternate" hreflang="{{ alternate_lang }}" href="{{ lang_url_map[alternate_lang] }}" />
                {%- endif -%}
              {%- endfor %}
  </url>
            {%- endunless -%}
          {%- endif -%}
        {%- endfor -%}

      {%- endunless -%}
    {%- endif -%}
  {%- endunless -%}
{%- endfor %}

{%- comment -%} POSTS - End of post specific code {%- endcomment -%}
</urlset>