{%- assign all_pages = site.pages -%}
{%- for collection in site.collections -%}
  {%- assign all_pages = all_pages | concat: collection.docs -%}
{%- endfor -%}

{%- for lang_code in site.languages -%}
  {%- assign current_page_url = page.url -%}
  {%- assign alt_url = nil -%}

  {%- if page.lang == site.default_lang -%}
    {%- assign alt_url = '/' | append: lang_code | append: current_page_url -%}
  {%- elsif lang_code == site.default_lang -%}
    {%- assign current_prefix = '/' | append: page.lang | append: '/' -%}
    {%- assign alt_url = current_page_url | replace_first: current_prefix, '/' -%}
  {%- else -%}
    {%- assign current_prefix = '/' | append: page.lang | append: '/' -%}
    {%- assign alt_prefix = '/' | append: lang_code | append: '/' -%}
    {%- assign alt_url = current_page_url | replace_first: current_prefix, alt_prefix -%}
  {%- endif -%}

  {%- assign alt_page = all_pages | where: "url", alt_url | first -%}

  {%- if alt_page and lang_code != page.lang -%}
    <link rel="alternate" hreflang="{{ lang_code }}" href="{{ site.url }}{{ alt_page.url }}" />
  {%- endif -%}
{%- endfor -%}

{%- if page.lang == site.default_lang -%}
  <link rel="alternate" hreflang="x-default" href="{{ site.url }}{{ page.url }}" />
{%- else -%}
  {%- assign current_prefix = '/' | append: page.lang | append: '/' -%}
  {%- assign default_url = page.url | replace_first: current_prefix, '/' -%}
  {%- assign default_page = all_pages | where: "url", default_url | first -%}
  {%- if default_page -%}
    <link rel="alternate" hreflang="x-default" href="{{ site.url }}{{ default_page.url }}" />
  {%- endif -%}
{%- endif -%}


<script>
  document.addEventListener('DOMContentLoaded', function () {
    const languageDropdown = document.getElementById('languageDropdown');
    const availableLanguages = Array.from(languageDropdown ? languageDropdown.options : []).map((option) => option.value);

    if (availableLanguages.length === 0) {
      availableLanguages.push('en', 'de'); // Add your default languages if dropdown is absent
    }

    let preferredLanguageFromLocalStorage = localStorage.getItem("languageDropdownValue");

    const currentPathname = window.location.pathname;
    let currentPageLangFromUrl = 'en'; // Default to 'en'
    const match = currentPathname.match(/^\/([a-z]{2})(\/|$)/);

    // Determine the current page's language based on its URL
    if (match && match[1] !== 'en' && availableLanguages.includes(match[1])) {
      // If the URL has a language prefix (and it's not 'en') AND it's a valid available language
      currentPageLangFromUrl = match[1];
    } else if (!match && currentPathname !== '/') {
      // If no language prefix and not root, assume English.
      // This is for pages like /about if they are only in English and directly at root.
      currentPageLangFromUrl = 'en';
    }
    // If it's '/', it defaults to 'en'

    let finalPreferredLanguageForScript = preferredLanguageFromLocalStorage;

    // --- LOGIC FOR AUTOMATIC LOCALSTORAGE SETTING / REDIRECTION ---
    // If localStorage is NOT set OR the stored language is not valid/available:
    if (!preferredLanguageFromLocalStorage || !availableLanguages.includes(preferredLanguageFromLocalStorage)) {
      // If the current page's URL indicates a specific language (and it's not 'en' default):
      if (currentPageLangFromUrl !== 'en') { // Check if the current page is a non-default language
        // Set preferred language to the current page's language
        finalPreferredLanguageForScript = currentPageLangFromUrl;
        localStorage.setItem("languageDropdownValue", currentPageLangFromUrl);
        console.log(`User landed on a ${currentPageLangFromUrl} page. Setting localStorage preference.`);
      } else {
        // User landed on an English page, and no localStorage preference exists.
        // Do not set localStorage, let them choose. No auto-redirect here.
        finalPreferredLanguageForScript = 'en'; // Ensure dropdown defaults to English
        console.log('User landed on an English page with no localStorage preference. No auto-redirect.');
      }
      // In this block (localStorage not set), we explicitly avoid any automatic redirects.
    } else {
      // localStorage IS set and valid. This is for returning users.
      // We will potentially redirect them to their stored preferred language,
      // unless they are already on that exact page.
      finalPreferredLanguageForScript = preferredLanguageFromLocalStorage;
      console.log(`LocalStorage preference found: ${finalPreferredLanguageForScript}. Checking for redirect.`);
    }

    // --- Update the dropdown value based on the final determined language for the script ---
    if (languageDropdown) {
      if (availableLanguages.includes(finalPreferredLanguageForScript)) {
        languageDropdown.value = finalPreferredLanguageForScript;
      } else {
        // Fallback if computed language somehow isn't in dropdown options
        languageDropdown.value = 'en';
      }
    }


    // --- Redirection Logic (only if localStorage was set OR explicitly set by landing on non-EN page) ---
    // Only redirect if a 'finalPreferredLanguageForScript' was determined AND
    // if the current page's URL language doesn't match this determined language.
    const isCurrentPagePreferred = (currentPageLangFromUrl === finalPreferredLanguageForScript);

    // Proceed with fetch-based redirection only if localStorage was set and current page is not preferred language
    if (preferredLanguageFromLocalStorage && availableLanguages.includes(preferredLanguageFromLocalStorage) && !isCurrentPagePreferred) {
      const currentHostname = window.location.hostname;
      const currentProtocol = window.location.protocol;
      const currentSearch = window.location.search;
      const currentHash = window.location.hash;

      function normalizePathForComparison(path) {
        if (!path) return '/';
        let normalized = path.replace(/\/\/+/g, '/');
        if (normalized.length > 1 && normalized.endsWith('/')) {
          normalized = normalized.slice(0, -1);
        }
        if (!normalized.startsWith('/')) {
          normalized = '/' + normalized;
        }
        return normalized;
      }

      let baseContentPath = '/';
      const anyTwoLetterFolderRegex = /^\/([a-z]{2})(\/.*)?$/;
      const pathSegmentMatch = currentPathname.match(anyTwoLetterFolderRegex);

      if (pathSegmentMatch) {
        baseContentPath = pathSegmentMatch[2] || '/';
      } else {
        baseContentPath = currentPathname;
      }
      baseContentPath = normalizePathForComparison(baseContentPath);

      let targetPathname;
      if (finalPreferredLanguageForScript === "en") {
        targetPathname = baseContentPath;
      } else {
        targetPathname = `/${finalPreferredLanguageForScript}${baseContentPath === '/' ? '/' : baseContentPath}`;
      }
      targetPathname = normalizePathForComparison(targetPathname);

      const normalizedCurrentPathForComparison = normalizePathForComparison(currentPathname);
      const normalizedTargetPathForComparison = normalizePathForComparison(targetPathname);

      if (normalizedCurrentPathForComparison !== normalizedTargetPathForComparison) {
        const currentFullUrl = `${currentProtocol}//${currentHostname}${currentPathname}${currentSearch}${currentHash}`;
        const targetFullUrl = `${currentProtocol}//${currentHostname}${targetPathname}${currentSearch}${currentHash}`;
        const fallbackToEnglishFullUrl = `${currentProtocol}//${currentHostname}${baseContentPath}${currentSearch}${currentHash}`;

        fetch(targetFullUrl, { method: 'HEAD' })
          .then(response => {
            if (response.ok) {
              window.location.replace(targetFullUrl);
            } else {
              if (normalizedCurrentPathForComparison !== normalizePathForComparison(baseContentPath)) {
                window.location.replace(fallbackToEnglishFullUrl);
              }
            }
          })
          .catch(error => {
            if (normalizedCurrentPathForComparison !== normalizePathForComparison(baseContentPath)) {
              window.location.replace(fallbackToEnglishFullUrl);
            }
          });
      }
    } else {
      console.log('No automatic redirection needed or allowed for this session.');
    }
  });

  // --- Separate Event Listener for User Interaction with the Dropdown ---
  document.addEventListener('DOMContentLoaded', function () {
    const languageDropdown = document.getElementById('languageDropdown');
    if (languageDropdown) {
      languageDropdown.addEventListener('change', function () {
        const selectedLanguage = this.value;
        localStorage.setItem("languageDropdownValue", selectedLanguage); // Save user's explicit choice

        const currentPathname = window.location.pathname;
        const currentSearch = window.location.search;
        const currentHash = window.location.hash;

        let newPathname = '';
        let baseContentPath = '/';
        const anyTwoLetterFolderRegex = /^\/([a-z]{2})(\/.*)?$/;
        const pathSegmentMatch = currentPathname.match(anyTwoLetterFolderRegex);

        if (pathSegmentMatch) {
          baseContentPath = pathSegmentMatch[2] || '/';
        } else {
          baseContentPath = currentPathname;
        }
        baseContentPath = baseContentPath.length > 1 && baseContentPath.endsWith('/') ? baseContentPath.slice(0, -1) : baseContentPath;

        if (selectedLanguage === "en") {
          newPathname = baseContentPath;
        } else {
          newPathname = `/${selectedLanguage}${baseContentPath === '/' ? '' : baseContentPath}`;
        }

        newPathname = newPathname.replace(/\/\/+/g, '/').replace(/^(?!.*\/)/, '/');
        window.location.href = `${window.location.protocol}//${window.location.hostname}${newPathname}${currentSearch}${currentHash}`;
      });
    }
  });
</script>


<script>
  document.addEventListener("DOMContentLoaded", function () {
    const links = document.querySelectorAll("a[href]");

    const externalLinkSvg = `
            <svg xmlns="http://www.w3.org/2000/svg" width="0.75em" height="0.75em" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
              <polyline points="15 3 21 3 21 9"></polyline>
              <line x1="10" y1="14" x2="21" y2="3"></line>
            </svg>
          `;

    links.forEach(link => {
      try {
        const url = new URL(link.href, window.location.href);

        if (url.hostname.toLowerCase() !== window.location.hostname.toLowerCase()) {
          link.setAttribute("target", "_blank");
        }

        if ((link.getAttribute("target") || "").toLowerCase() === "_blank") {
          let targetElement = link;
          const buttonChild = link.querySelector('button');
          if (buttonChild) {
            targetElement = buttonChild;
          }

          if (!targetElement.querySelector(".icon svg")) {
            const iconSpan = document.createElement("span");
            iconSpan.classList.add("icon");
            iconSpan.style.marginLeft = "0.2em";
            iconSpan.style.verticalAlign = "middle";
            iconSpan.innerHTML = externalLinkSvg.trim();
            targetElement.appendChild(iconSpan);
          }
        }
      } catch (e) {
        // Invalid URL, skip
      }
    });
  });
</script>


<script>
  document.addEventListener("DOMContentLoaded", function () {
    const headings = document.querySelectorAll("h1, h2, h3, h4, h5, h6");

    headings.forEach(function (heading) {
      if (!heading.id) {
        // Generate a slug from the heading text
        const slug = heading.textContent
          .toLowerCase()
          .trim()
          .replace(/[^\w\s-]/g, '') // Remove non-word characters
          .replace(/\s+/g, '-');    // Replace spaces with dashes

        // Ensure uniqueness by appending a number if needed
        let uniqueSlug = slug;
        let counter = 1;
        while (document.getElementById(uniqueSlug)) {
          uniqueSlug = `${slug}-${counter++}`;
        }
        heading.id = uniqueSlug;
      }

      const anchor = document.createElement("a");
      anchor.href = `#${heading.id}`;
      anchor.className = "anchor-link";
      anchor.innerHTML = "🔗";

      heading.insertBefore(anchor, heading.firstChild);
    });
  });
</script>