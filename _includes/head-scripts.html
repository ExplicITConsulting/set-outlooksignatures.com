{% assign all_pages = site.pages %}
{% for collection in site.collections %}
  {% assign all_pages = all_pages | concat: collection.docs %}
{% endfor %}

{% for lang in site.languages %}
  {% if lang != page.lang %}
    {% if page.lang == site.default_lang %}
      {% assign alt_url = '/' | append: lang | append: page.url %}
    {% elsif lang == site.default_lang %}
      {% assign alt_url = page.url | remove_first: '/' | split: '/' | slice: 1, 10 | join: '/' | prepend: '/' %}
    {% else %}
      {% assign alt_prefix = '/' | append: lang | append: '/' %}
      {% assign current_prefix = '/' | append: page.lang | append: '/' %}
      {% assign alt_url = page.url | replace_first: current_prefix, alt_prefix %}
    {% endif %}

    {% assign alt_page = all_pages | where: "url", alt_url | first %}
    {% if alt_page %}
      <link rel="alternate" hreflang="{{ lang }}" href="{{ site.url }}{{ alt_page.url }}" />
    {% endif %}
  {% endif %}
{% endfor %}

{%- comment -%}
  Always add x-default hreflang pointing to the current page if it's in the default language,
  or to the default language version if it's a translated page.
{%- endcomment -%}
{% if page.lang == site.default_lang %}
  <link rel="alternate" hreflang="x-default" href="{{ site.url }}{{ page.url }}" />
{% else %}
  {% assign default_url = page.url | remove_first: '/' | split: '/' | slice: 1, 10 | join: '/' | prepend: '/' %}
  {% assign default_page = all_pages | where: "url", default_url | first %}
  {% if default_page %}
    <link rel="alternate" hreflang="x-default" href="{{ site.url }}{{ default_page.url }}" />
  {% endif %}
{% endif %}



<script>
  document.addEventListener('DOMContentLoaded', function () {
    const languageDropdown = document.getElementById('languageDropdown');
    // Important: If languageDropdown might not exist on all pages,
    // consider a robust fallback or ensure it's always present.
    // For now, assume it's always there for language detection.
    const availableLanguages = Array.from(languageDropdown ? languageDropdown.options : []).map((option) => option.value);
    // Fallback if no dropdown exists (e.g., on a 404 page, or if dropdown isn't in layout)
    if (availableLanguages.length === 0) {
      availableLanguages.push('en', 'de'); // Add your default languages if dropdown is absent
    }


    let preferredLanguage = localStorage.getItem("languageDropdownValue");

    // 1. Check if preferredLanguage is already set and valid
    if (preferredLanguage && availableLanguages.includes(preferredLanguage)) {
      // Valid preferredLanguage from localStorage, use it.
    } else {
      // 2. Try to get preferred language from navigator.languages
      if (navigator.languages && navigator.languages.length > 0) {
        for (let i = 0; i < navigator.languages.length; i++) {
          const browserLang = navigator.languages[i].toLowerCase().split("-")[0];
          if (availableLanguages.includes(browserLang)) {
            preferredLanguage = browserLang;
            break; // Found a match
          }
        }
      }

      // 3. Fallback to navigator.language or navigator.userLanguage
      if (!preferredLanguage) {
        const fallbackLang = (navigator.language || navigator.userLanguage || "").toLowerCase().split("-")[0];
        if (availableLanguages.includes(fallbackLang)) {
          preferredLanguage = fallbackLang;
        }
      }

      // 4. Final fallback to "en" if no suitable language was found
      if (!preferredLanguage) {
        preferredLanguage = "en"; // Default fallback
      }
    }

    // Update the dropdown value and localStorage if you have a dropdown
    if (languageDropdown) {
      languageDropdown.value = preferredLanguage;
    }

    // Do not set localStorage here, but only when the user explicitly changes the dropdown
    // localStorage.setItem("languageDropdownValue", preferredLanguage);

    const currentPathname = window.location.pathname;
    const currentHostname = window.location.hostname;
    const currentProtocol = window.location.protocol;
    const currentSearch = window.location.search;
    const currentHash = window.location.hash;

    /**
     * Normalizes a path by removing a trailing slash, unless it's the root path '/'.
     * Also ensures a single leading slash and removes internal double slashes.
     * @param {string} path The path to normalize.
     * @returns {string} The normalized path.
     */
    function normalizePathForComparison(path) {
      if (!path) return '/';
      let normalized = path.replace(/\/\/+/g, '/');
      if (normalized.length > 1 && normalized.endsWith('/')) {
        normalized = normalized.slice(0, -1);
      }
      if (!normalized.startsWith('/')) {
        normalized = '/' + normalized;
      }
      return normalized;
    }

    let baseContentPath = '/';
    const anyTwoLetterFolderRegex = /^\/([a-z]{2})(\/.*)?$/;
    const pathSegmentMatch = currentPathname.match(anyTwoLetterFolderRegex);

    if (pathSegmentMatch) {
      baseContentPath = pathSegmentMatch[2] || '/';
    } else {
      baseContentPath = currentPathname;
    }
    baseContentPath = normalizePathForComparison(baseContentPath);

    let targetPathname;
    if (preferredLanguage === "en") {
      targetPathname = baseContentPath;
    } else {
      targetPathname = `/${preferredLanguage}${baseContentPath === '/' ? '/' : baseContentPath}`;
    }
    targetPathname = normalizePathForComparison(targetPathname);

    const normalizedCurrentPathForComparison = normalizePathForComparison(currentPathname);
    const normalizedTargetPathForComparison = normalizePathForComparison(targetPathname);

    if (normalizedCurrentPathForComparison !== normalizedTargetPathForComparison) {
      const currentFullUrl = `${currentProtocol}//${currentHostname}${currentPathname}${currentSearch}${currentHash}`;
      const targetFullUrl = `${currentProtocol}//${currentHostname}${targetPathname}${currentSearch}${currentHash}`;
      const fallbackToEnglishFullUrl = `${currentProtocol}//${currentHostname}${baseContentPath}${currentSearch}${currentHash}`;

      fetch(targetFullUrl, { method: 'HEAD' })
        .then(response => {
          if (response.ok) {
            // The target URL exists, proceed with redirection
            window.location.replace(targetFullUrl);
          } else {
            // The target URL does NOT exist, fall back to English
            if (normalizedCurrentPathForComparison !== normalizePathForComparison(baseContentPath)) {
              window.location.replace(fallbackToEnglishFullUrl);
            }
          }
        })
        .catch(error => {
          if (normalizedCurrentPathForComparison !== normalizePathForComparison(baseContentPath)) {
            window.location.replace(fallbackToEnglishFullUrl);
          }
        });
    } else {
      // No redirect needed, the current page is already the correct preferred language
    }
  });
</script>


<script>
  document.addEventListener("DOMContentLoaded", function () {
    const links = document.querySelectorAll("a[href]");

    const externalLinkSvg = `
            <svg xmlns="http://www.w3.org/2000/svg" width="0.75em" height="0.75em" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
              <polyline points="15 3 21 3 21 9"></polyline>
              <line x1="10" y1="14" x2="21" y2="3"></line>
            </svg>
          `;

    links.forEach(link => {
      try {
        const url = new URL(link.href, window.location.href);

        if (url.hostname.toLowerCase() !== window.location.hostname.toLowerCase()) {
          link.setAttribute("target", "_blank");
        }

        if ((link.getAttribute("target") || "").toLowerCase() === "_blank") {
          let targetElement = link;
          const buttonChild = link.querySelector('button');
          if (buttonChild) {
            targetElement = buttonChild;
          }

          if (!targetElement.querySelector(".icon svg")) {
            const iconSpan = document.createElement("span");
            iconSpan.classList.add("icon");
            iconSpan.style.marginLeft = "0.2em";
            iconSpan.style.verticalAlign = "middle";
            iconSpan.innerHTML = externalLinkSvg.trim();
            targetElement.appendChild(iconSpan);
          }
        }
      } catch (e) {
        // Invalid URL, skip
      }
    });
  });
</script>


<script>
  document.addEventListener("DOMContentLoaded", function () {
    const headings = document.querySelectorAll("h1, h2, h3, h4, h5, h6");

    headings.forEach(function (heading) {
      if (!heading.id) {
        // Generate a slug from the heading text
        const slug = heading.textContent
          .toLowerCase()
          .trim()
          .replace(/[^\w\s-]/g, '') // Remove non-word characters
          .replace(/\s+/g, '-');    // Replace spaces with dashes

        // Ensure uniqueness by appending a number if needed
        let uniqueSlug = slug;
        let counter = 1;
        while (document.getElementById(uniqueSlug)) {
          uniqueSlug = `${slug}-${counter++}`;
        }
        heading.id = uniqueSlug;
      }

      const anchor = document.createElement("a");
      anchor.href = `#${heading.id}`;
      anchor.className = "anchor-link";
      anchor.innerHTML = "ðŸ”—";

      heading.insertBefore(anchor, heading.firstChild);
    });
  });
</script>