{%- assign all_pages = site.pages -%}
{%- for collection in site.collections -%}
  {%- assign all_pages = all_pages | concat: collection.docs -%}
{%- endfor -%}

{%- for lang_code in site.languages -%}
  {%- assign current_page_url = page.url -%}
  {%- assign alt_url = nil -%}

  {%- if page.lang == site.default_lang -%}
    {%- assign alt_url = '/' | append: lang_code | append: current_page_url -%}
  {%- elsif lang_code == site.default_lang -%}
    {%- assign current_prefix = '/' | append: page.lang | append: '/' -%}
    {%- assign alt_url = current_page_url | replace_first: current_prefix, '/' -%}
  {%- else -%}
    {%- assign current_prefix = '/' | append: page.lang | append: '/' -%}
    {%- assign alt_prefix = '/' | append: lang_code | append: '/' -%}
    {%- assign alt_url = current_page_url | replace_first: current_prefix, alt_prefix -%}
  {%- endif -%}

  {%- assign alt_page = all_pages | where: "url", alt_url | first -%}

  {%- if alt_page and lang_code != page.lang -%}
    <link rel="alternate" hreflang="{{ lang_code }}" href="{{ site.url }}{{ alt_page.url }}" />
  {%- endif -%}
{%- endfor -%}

{%- if page.lang == site.default_lang -%}
  <link rel="alternate" hreflang="x-default" href="{{ site.url }}{{ page.url }}" />
{%- else -%}
  {%- assign current_prefix = '/' | append: page.lang | append: '/' -%}
  {%- assign default_url = page.url | replace_first: current_prefix, '/' -%}
  {%- assign default_page = all_pages | where: "url", default_url | first -%}
  {%- if default_page -%}
    <link rel="alternate" hreflang="x-default" href="{{ site.url }}{{ default_page.url }}" />
  {%- endif -%}
{%- endif -%}


<script>
  // --- Helper Function (GLOBAL SCOPE) ---
  // This function needs to be accessible to both the initial load logic
  // and the dropdown change handler.
  /**
   * Normalizes a path by removing a trailing slash, unless it's the root path '/'.
   * Also ensures a single leading slash and removes internal double slashes.
   * @param {string} path The path to normalize.
   * @returns {string} The normalized path.
   */
  function normalizePathForComparison(path) {
      if (!path) return '/';
      let normalized = path.replace(/\/\/+/g, '/');
      if (normalized.length > 1 && normalized.endsWith('/')) {
          normalized = normalized.slice(0, -1);
      }
      if (!normalized.startsWith('/')) {
          normalized = '/' + normalized;
      }
      return normalized;
  }


  document.addEventListener('DOMContentLoaded', function () {
      const languageDropdown = document.getElementById('languageDropdown');
      const availableLanguages = Array.from(languageDropdown ? languageDropdown.options : []).map((option) => option.value);
      
      // Fallback if no dropdown exists (e.g., on a 404 page, or if dropdown isn't in layout)
      if (availableLanguages.length === 0) {
          availableLanguages.push('en', 'de'); // Add your default languages if dropdown is absent
      }

      let preferredLanguageFromLocalStorage = localStorage.getItem("languageDropdownValue");

      const currentPathname = window.location.pathname;
      let currentPageLangFromUrl = 'en'; // Default to 'en'

      // Determine the current page's language based on its URL
      const match = currentPathname.match(/^\/([a-z]{2})(\/|$)/);
      if (match && availableLanguages.includes(match[1])) {
          // If the URL has a valid two-letter language prefix
          currentPageLangFromUrl = match[1];
      } else {
          // If no language prefix, assume 'en' as default or if root path
          currentPageLangFromUrl = 'en';
      }


      // --- Only set dropdown value, do NOT auto-redirect based on localStorage if it's not set ---
      if (languageDropdown) {
          if (preferredLanguageFromLocalStorage && availableLanguages.includes(preferredLanguageFromLocalStorage)) {
              // If localStorage is set and valid, use it to set the dropdown.
              languageDropdown.value = preferredLanguageFromLocalStorage;
          } else {
              // If localStorage is NOT set, or is invalid, initialize dropdown to the current page's language from URL.
              languageDropdown.value = currentPageLangFromUrl;
          }
      }

      // --- FLASH LANGUAGE SELECTOR LOGIC ---
      // Condition 1: localStorage is not set
      const localStorageNotSet = (!preferredLanguageFromLocalStorage || !availableLanguages.includes(preferredLanguageFromLocalStorage));

      let browserPreferredLanguage = null;
      // Condition 2: Determine preferred browser language (if localStorage not set)
      if (localStorageNotSet) {
          if (navigator.languages && navigator.languages.length > 0) {
              for (let i = 0; i < navigator.languages.length; i++) {
                  const browserLang = navigator.languages[i].toLowerCase().split("-")[0];
                  if (availableLanguages.includes(browserLang)) {
                      browserPreferredLanguage = browserLang;
                      break; // Found a match
                  }
              }
          }
          if (!browserPreferredLanguage) { // Fallback to navigator.language
              const fallbackLang = (navigator.language || navigator.userLanguage || "").toLowerCase().split("-")[0];
              if (availableLanguages.includes(fallbackLang)) {
                  browserPreferredLanguage = fallbackLang;
              }
          }
      }

      // Condition 3: The current page is NOT shown in the preferred browser language
      const currentIsDifferentFromBrowserPref = (browserPreferredLanguage && currentPageLangFromUrl !== browserPreferredLanguage);

      // Condition 4: The current page IS available in the preferred browser language
      let alternatePageExistsInBrowserPref = false;
      if (browserPreferredLanguage && currentIsDifferentFromBrowserPref) {
          // Construct the potential alternate URL for the browser's preferred language
          let baseContentPathForAlt = '/';
          const currentPathMatchForAlt = currentPathname.match(/^\/([a-z]{2})(\/.*)?$/);
          if (currentPathMatchForAlt) {
              baseContentPathForAlt = currentPathMatchForAlt[2] || '/';
          } else {
              baseContentPathForAlt = currentPathname;
          }
          baseContentPathForAlt = normalizePathForComparison(baseContentPathForAlt); // <--- Uses the global function

          let potentialAltPathname;
          if (browserPreferredLanguage === "en") {
              potentialAltPathname = baseContentPathForAlt;
          } else {
              potentialAltPathname = `/${browserPreferredLanguage}${baseContentPathForAlt === '/' ? '/' : baseContentPathForAlt}`;
          }
          potentialAltPathname = normalizePathForComparison(potentialAltPathname); // <--- Uses the global function

          // Assume existence for now based on valid language if no explicit page list is available.
          if (availableLanguages.includes(browserPreferredLanguage)) {
              alternatePageExistsInBrowserPref = true;
          }
      }


      // Final check for flashing the dropdown
      if (localStorageNotSet && browserPreferredLanguage && currentIsDifferentFromBrowserPref && alternatePageExistsInBrowserPref) {
          console.log(`Conditions met: localStorage not set, browser prefers ${browserPreferredLanguage}, current page is ${currentPageLangFromUrl}. Attempting to flash language dropdown.`);
          if (languageDropdown) {
              languageDropdown.classList.add('flash-language-dropdown');
              setTimeout(() => {
                  languageDropdown.classList.remove('flash-language-dropdown');
              }, 5000);
          }
      }


      // --- Redirection Logic: ONLY if localStorage is set AND valid AND current page is not already the preferred language ---
      if (preferredLanguageFromLocalStorage && availableLanguages.includes(preferredLanguageFromLocalStorage) && currentPageLangFromUrl !== preferredLanguageFromLocalStorage) {
          console.log(`LocalStorage preference found (${preferredLanguageFromLocalStorage}). Current page is ${currentPageLangFromUrl}. Initiating redirect.`);

          const currentHostname = window.location.hostname;
          const currentProtocol = window.location.protocol;
          const currentSearch = window.location.search;
          const currentHash = window.location.hash;

          let baseContentPath = '/';
          const anyTwoLetterFolderRegex = /^\/([a-z]{2})(\/.*)?$/;
          const pathSegmentMatch = currentPathname.match(anyTwoLetterFolderRegex);

          if (pathSegmentMatch) {
              baseContentPath = pathSegmentMatch[2] || '/';
          } else {
              baseContentPath = currentPathname;
          }
          baseContentPath = normalizePathForComparison(baseContentPath); // <--- Uses the global function

          let targetPathname;
          if (preferredLanguageFromLocalStorage === "en") {
              targetPathname = baseContentPath;
          } else {
              targetPathname = `/${preferredLanguageFromLocalStorage}${baseContentPath === '/' ? '/' : baseContentPath}`;
          }
          targetPathname = normalizePathForComparison(targetPathname); // <--- Uses the global function

          const normalizedCurrentPathForComparison = normalizePathForComparison(currentPathname); // <--- Uses the global function
          const normalizedTargetPathForComparison = normalizePathForComparison(targetPathname); // <--- Uses the global function (Fixed typo)

          if (normalizedCurrentPathForComparison !== normalizedTargetPathForComparison) {
              const currentFullUrl = `${currentProtocol}//${currentHostname}${currentPathname}${currentSearch}${currentHash}`;
              const targetFullUrl = `${currentProtocol}//${currentHostname}${targetPathname}${currentSearch}${currentHash}`;
              const fallbackToEnglishFullUrl = `${currentProtocol}//${currentHostname}${baseContentPath}${currentSearch}${currentHash}`;

              fetch(targetFullUrl, { method: 'HEAD' })
                  .then(response => {
                      if (response.ok) {
                          window.location.replace(targetFullUrl);
                      } else {
                          if (currentPageLangFromUrl !== 'en') {
                              window.location.replace(fallbackToEnglishFullUrl);
                          }
                      }
                  })
                  .catch(error => {
                      if (currentPageLangFromUrl !== 'en') {
                          window.location.replace(fallbackToEnglishFullUrl);
                      }
                  });
          }
      } else {
          console.log('No automatic redirection for this session (localStorage not set or already on preferred page).');
      }
  });


  // --- Your separate Event Listener for User Interaction with the Dropdown (unchanged apart from using global normalizePathForComparison) ---
  document.addEventListener('DOMContentLoaded', function () {
      const languageDropdown = document.getElementById('languageDropdown');
      if (languageDropdown) {
          languageDropdown.addEventListener('change', function () {
              const selectedLanguage = this.value;
              localStorage.setItem("languageDropdownValue", selectedLanguage);

              const currentPathname = window.location.pathname;
              const currentSearch = window.location.search;
              const currentHash = window.location.hash;

              let newPathname = '';
              let baseContentPath = '/';
              const anyTwoLetterFolderRegex = /^\/([a-z]{2})(\/.*)?$/;
              const pathSegmentMatch = currentPathname.match(anyTwoLetterFolderRegex);

              if (pathSegmentMatch) {
                  baseContentPath = pathSegmentMatch[2] || '/';
              } else {
                  baseContentPath = currentPathname;
              }
              baseContentPath = normalizePathForComparison(baseContentPath); // <--- Uses the global function

              if (selectedLanguage === "en") {
                  newPathname = baseContentPath;
              } else {
                  newPathname = `/${selectedLanguage}${baseContentPath === '/' ? '' : baseContentPath}`;
              }

              newPathname = newPathname.replace(/\/\/+/g, '/').replace(/^(?!.*\/)/, '/');
              window.location.href = `${window.location.protocol}//${window.location.hostname}${newPathname}${currentSearch}${currentHash}`;
          });
      }
  });
</script>


<script>
  document.addEventListener("DOMContentLoaded", function () {
    const links = document.querySelectorAll("a[href]");

    const externalLinkSvg = `
            <svg xmlns="http://www.w3.org/2000/svg" width="0.75em" height="0.75em" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
              <polyline points="15 3 21 3 21 9"></polyline>
              <line x1="10" y1="14" x2="21" y2="3"></line>
            </svg>
          `;

    links.forEach(link => {
      try {
        const url = new URL(link.href, window.location.href);

        if (url.hostname.toLowerCase() !== window.location.hostname.toLowerCase()) {
          link.setAttribute("target", "_blank");
        }

        if ((link.getAttribute("target") || "").toLowerCase() === "_blank") {
          let targetElement = link;
          const buttonChild = link.querySelector('button');
          if (buttonChild) {
            targetElement = buttonChild;
          }

          if (!targetElement.querySelector(".icon svg")) {
            const iconSpan = document.createElement("span");
            iconSpan.classList.add("icon");
            iconSpan.style.marginLeft = "0.2em";
            iconSpan.style.verticalAlign = "middle";
            iconSpan.innerHTML = externalLinkSvg.trim();
            targetElement.appendChild(iconSpan);
          }
        }
      } catch (e) {
        // Invalid URL, skip
      }
    });
  });
</script>


<script>
  document.addEventListener("DOMContentLoaded", function () {
    const headings = document.querySelectorAll("h1, h2, h3, h4, h5, h6");

    headings.forEach(function (heading) {
      if (!heading.id) {
        // Generate a slug from the heading text
        const slug = heading.textContent
          .toLowerCase()
          .trim()
          .replace(/[^\w\s-]/g, '') // Remove non-word characters
          .replace(/\s+/g, '-');    // Replace spaces with dashes

        // Ensure uniqueness by appending a number if needed
        let uniqueSlug = slug;
        let counter = 1;
        while (document.getElementById(uniqueSlug)) {
          uniqueSlug = `${slug}-${counter++}`;
        }
        heading.id = uniqueSlug;
      }

      const anchor = document.createElement("a");
      anchor.href = `#${heading.id}`;
      anchor.className = "anchor-link";
      anchor.innerHTML = "🔗";

      heading.insertBefore(anchor, heading.firstChild);
    });
  });
</script>